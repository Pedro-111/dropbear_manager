#!/bin/bash

# üé® Colores y s√≠mbolos Unicode
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# üéØ Banner del programa
show_banner() {
    clear
    echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${CYAN}‚ïë                     üîê DROPBEAR MANAGER                        ‚ïë${NC}"
    echo -e "${CYAN}‚ïë                   Gestor SSH Seguro v2.0                       ‚ïë${NC}"
    echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
}

# üîç Verificar si se est√° ejecutando como root
check_root() {
    if [ "$(id -u)" != "0" ]; then
        echo -e "${RED}‚ö†Ô∏è  Este script debe ser ejecutado como root${NC}"
        echo -e "${YELLOW}üí° Usa: ${WHITE}sudo dropbear-manager${NC}"
        exit 1
    fi
}

# üõ†Ô∏è Funci√≥n para verificar si un comando necesita sudo
need_sudo() {
    if [ "$(id -u)" != "0" ]; then
        echo "sudo"
    fi
}

# üì¶ Verificar dependencias
check_dependencies() {
    echo -e "${YELLOW}üîç Verificando dependencias...${NC}"
    
    local missing_deps=()
    
    if ! command -v netstat &> /dev/null; then
        missing_deps+=("net-tools")
    fi
    
    if ! command -v lsof &> /dev/null; then
        missing_deps+=("lsof")
    fi
    
    if ! command -v curl &> /dev/null; then
        missing_deps+=("curl")
    fi
    
    if [ ${#missing_deps[@]} -gt 0 ]; then
        echo -e "${YELLOW}üì¶ Instalando dependencias faltantes: ${missing_deps[*]}${NC}"
        apt-get update > /dev/null 2>&1
        apt-get install -y "${missing_deps[@]}" > /dev/null 2>&1
        echo -e "${GREEN}‚úÖ Dependencias instaladas correctamente${NC}"
    else
        echo -e "${GREEN}‚úÖ Todas las dependencias est√°n instaladas${NC}"
    fi
}

# ‚úÖ Funci√≥n para validar la configuraci√≥n de Dropbear
validate_dropbear_config() {
    echo -e "${YELLOW}üîß Validando configuraci√≥n de Dropbear...${NC}"
    if ! sh -n /etc/default/dropbear 2>/dev/null; then
        echo -e "${RED}‚ùå Error en la configuraci√≥n de Dropbear. Corrigiendo...${NC}"
        sed -i '/^[0-9]/d' /etc/default/dropbear
        echo -e "${GREEN}‚úÖ Configuraci√≥n corregida${NC}"
    else
        echo -e "${GREEN}‚úÖ Configuraci√≥n de Dropbear v√°lida${NC}"
    fi
}

# üöÄ Instalar Dropbear
install_dropbear() {
    show_banner
    echo -e "${BOLD}${BLUE}üì• INSTALACI√ìN DE DROPBEAR${NC}"
    echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""
    
    if command -v dropbear &> /dev/null; then
        echo -e "${YELLOW}‚ö†Ô∏è  Dropbear ya est√° instalado${NC}"
        read -p "üîÑ ¬øDesea reinstalarlo? (s/n): " reinstall
        if [ "$reinstall" != "s" ]; then
            return
        fi
    fi
    
    echo -e "${YELLOW}üì¶ Instalando Dropbear...${NC}"
    
    # Mostrar progreso
    {
        apt-get update
        apt-get install -y dropbear
    } > /dev/null 2>&1 &
    
    # Animaci√≥n de carga
    local pid=$!
    local spin='-\|/'
    local i=0
    while kill -0 $pid 2>/dev/null; do
        i=$(( (i+1) %4 ))
        printf "\r${YELLOW}üîÑ Instalando... ${spin:$i:1}${NC}"
        sleep 0.1
    done
    wait $pid
    printf "\r"
    
    if ! command -v dropbear &> /dev/null; then
        echo -e "${RED}‚ùå Error: La instalaci√≥n de Dropbear fall√≥${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}‚úÖ Dropbear instalado correctamente${NC}"
    
    clean_dropbear_config
    
    echo ""
    echo -e "${YELLOW}üîß Configurando puerto principal para Dropbear...${NC}"
    echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    
    while true; do
        echo ""
        read -p "üîå Ingrese el puerto principal para Dropbear (no use el puerto 22): " dropbear_port
        
        # Validar que sea un n√∫mero
        if ! [[ "$dropbear_port" =~ ^[0-9]+$ ]] || [ "$dropbear_port" -lt 1 ] || [ "$dropbear_port" -gt 65535 ]; then
            echo -e "${RED}‚ùå Puerto inv√°lido. Debe ser un n√∫mero entre 1 y 65535.${NC}"
            continue
        fi
        
        # Verificar si el puerto est√° en uso
        if netstat -tuln | grep ":$dropbear_port " > /dev/null; then
            echo -e "${RED}‚ùå El puerto $dropbear_port ya est√° en uso por otro proceso.${NC}"
            echo -e "${YELLOW}üí° Por favor, elija otro puerto.${NC}"
        elif [ "$dropbear_port" = "22" ]; then
            echo -e "${RED}‚ùå El puerto 22 no est√° permitido. Por favor, elija otro puerto.${NC}"
        else
            break
        fi
    done
    
    # Modificar la configuraci√≥n de Dropbear
    sed -i "s/^DROPBEAR_PORT=/DROPBEAR_PORT=$dropbear_port/" /etc/default/dropbear
    
    restart_dropbear
    
    echo ""
    echo -e "${GREEN}üéâ ¬°Dropbear instalado y configurado exitosamente!${NC}"
    echo -e "${WHITE}üìã Puerto configurado: ${YELLOW}$dropbear_port${NC}"
    
    read -p "Presiona Enter para continuar..."
}

# üîì Abrir puertos adicionales
open_ports() {
    show_banner
    echo -e "${BOLD}${BLUE}üîì ABRIR PUERTOS ADICIONALES${NC}"
    echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""
    
    if ! command -v dropbear &> /dev/null; then
        echo -e "${RED}‚ùå Dropbear no est√° instalado${NC}"
        read -p "Presiona Enter para continuar..."
        return
    fi
    
    read -p "üîå Ingrese el puerto adicional que desea abrir: " port
    
    # Validar puerto
    if ! [[ "$port" =~ ^[0-9]+$ ]] || [ "$port" -lt 1 ] || [ "$port" -gt 65535 ]; then
        echo -e "${RED}‚ùå Puerto inv√°lido. Debe ser un n√∫mero entre 1 y 65535.${NC}"
        read -p "Presiona Enter para continuar..."
        return
    fi
    
    if netstat -tuln | grep ":$port " > /dev/null; then
        echo -e "${RED}‚ùå El puerto $port ya est√° en uso por otro proceso.${NC}"
        read -p "Presiona Enter para continuar..."
        return
    fi
    
    if [ "$port" = "22" ]; then
        echo -e "${RED}‚ùå El puerto 22 no est√° permitido.${NC}"
        read -p "Presiona Enter para continuar..."
        return
    fi
    
    if lsof -i :$port > /dev/null 2>&1; then
        echo -e "${RED}‚ùå El puerto $port ya est√° en uso${NC}"
    else
        current_args=$(grep "^DROPBEAR_EXTRA_ARGS=" /etc/default/dropbear | cut -d'"' -f2)
        new_args="$current_args -p $port"
        sed -i "s/^DROPBEAR_EXTRA_ARGS=.*/DROPBEAR_EXTRA_ARGS=\"$new_args\"/" /etc/default/dropbear
        
        restart_dropbear
        echo -e "${GREEN}‚úÖ Puerto $port abierto exitosamente${NC}"
    fi
    
    read -p "Presiona Enter para continuar..."
}

# üîí Cerrar puerto
close_port() {
    show_banner
    echo -e "${BOLD}${BLUE}üîí CERRAR PUERTO${NC}"
    echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""
    
    if ! command -v dropbear &> /dev/null; then
        echo -e "${RED}‚ùå Dropbear no est√° instalado${NC}"
        read -p "Presiona Enter para continuar..."
        return
    fi
    
    # Mostrar puertos actuales
    echo -e "${WHITE}üìã Puertos actualmente configurados:${NC}"
    show_ports_inline
    echo ""
    
    read -p "üîå Ingrese el puerto que desea cerrar: " port
    
    if ! [[ "$port" =~ ^[0-9]+$ ]] || [ "$port" -lt 1 ] || [ "$port" -gt 65535 ]; then
        echo -e "${RED}‚ùå Puerto inv√°lido. Debe ser un n√∫mero entre 1 y 65535.${NC}"
        read -p "Presiona Enter para continuar..."
        return
    fi
    
    # Verificar si el puerto est√° configurado
    if ! grep -qE "DROPBEAR_PORT=$port|DROPBEAR_EXTRA_ARGS=.*-p $port" /etc/default/dropbear; then
        echo -e "${RED}‚ùå El puerto $port no est√° configurado para Dropbear${NC}"
        read -p "Presiona Enter para continuar..."
        return
    fi
    
    # Obtener la configuraci√≥n actual
    current_port=$(grep "^DROPBEAR_PORT=" /etc/default/dropbear | cut -d'=' -f2)
    current_args=$(grep "^DROPBEAR_EXTRA_ARGS=" /etc/default/dropbear | cut -d'"' -f2)
    
    if [ "$current_port" = "$port" ]; then
        echo -e "${RED}‚ö†Ô∏è  El puerto $port es el puerto principal de Dropbear${NC}"
        read -p "üîÑ ¬øDesea actualizar el puerto principal? (s/n): " choice
        if [ "$choice" = "s" ]; then
            read -p "üîå Ingrese el nuevo puerto principal: " new_port
            
            if ! [[ "$new_port" =~ ^[0-9]+$ ]] || [ "$new_port" -lt 1 ] || [ "$new_port" -gt 65535 ]; then
                echo -e "${RED}‚ùå Nuevo puerto inv√°lido${NC}"
                read -p "Presiona Enter para continuar..."
                return
            fi
            
            sed -i "s/^DROPBEAR_PORT=.*/DROPBEAR_PORT=$new_port/" /etc/default/dropbear
            echo -e "${GREEN}‚úÖ Puerto principal actualizado a $new_port exitosamente${NC}"
            restart_dropbear
        fi
    else
        # Si es un puerto adicional, lo removemos de DROPBEAR_EXTRA_ARGS
        new_args=$(echo $current_args | sed "s/-p $port//g" | sed 's/  */ /g' | sed 's/^ *//' | sed 's/ *$//')
        sed -i "s/^DROPBEAR_EXTRA_ARGS=.*/DROPBEAR_EXTRA_ARGS=\"$new_args\"/" /etc/default/dropbear
        echo -e "${GREEN}‚úÖ Puerto adicional $port cerrado exitosamente${NC}"
        restart_dropbear
    fi
    
    read -p "Presiona Enter para continuar..."
}

# üîÑ Reiniciar Dropbear con indicadores mejorados
restart_dropbear() {
    echo ""
    echo -e "${YELLOW}üîÑ Reiniciando Dropbear...${NC}"
    
    # Detener servicio
    service dropbear stop > /dev/null 2>&1
    sleep 1
    
    # Mostrar progreso con animaci√≥n
    {
        sleep 2
        service dropbear start
    } > /dev/null 2>&1 &
    
    local pid=$!
    local spin='-\|/'
    local i=0
    while kill -0 $pid 2>/dev/null; do
        i=$(( (i+1) %4 ))
        printf "\r${YELLOW}üîÑ Reiniciando servicio... ${spin:$i:1}${NC}"
        sleep 0.2
    done
    wait $pid
    local exit_code=$?
    printf "\r"
    
    if [ $exit_code -ne 0 ]; then
        echo -e "${RED}‚ùå Error al reiniciar Dropbear${NC}"
        echo -e "${YELLOW}üìã Mostrando logs de error:${NC}"
        service dropbear status
        journalctl -xeu dropbear.service --no-pager -n 10
        return 1
    fi
    
    sleep 1
    
    if ! pgrep -x "dropbear" > /dev/null; then
        echo -e "${RED}‚ùå Error: Dropbear no se est√° ejecutando despu√©s del reinicio${NC}"
        echo -e "${YELLOW}üìã Mostrando logs:${NC}"
        journalctl -xeu dropbear.service --no-pager -n 10
        return 1
    else
        echo -e "${GREEN}‚úÖ Dropbear reiniciado exitosamente${NC}"
        return 0
    fi
}

# üßπ Limpiar configuraci√≥n de Dropbear
clean_dropbear_config() {
    echo -e "${YELLOW}üßπ Limpiando configuraci√≥n de Dropbear...${NC}"
    
    if [ -f /etc/default/dropbear ]; then
        cp /etc/default/dropbear /etc/default/dropbear.bak.$(date +%Y%m%d_%H%M%S)
    fi
    
    cat > /etc/default/dropbear << 'EOF'
# Defaults for dropbear initscript
# sourced by /etc/init.d/dropbear
# installed at /etc/default/dropbear by the maintainer scripts

# Change to NO_START=0 to start dropbear at system boot
NO_START=0

# the TCP port that Dropbear listens on
DROPBEAR_PORT=

# any additional arguments for Dropbear
DROPBEAR_EXTRA_ARGS=""

# specify an optional banner file containing a message to be
# sent to clients before they connect, such as "/etc/issue.net"
DROPBEAR_BANNER=""

# RSA hostkey file (default: /etc/dropbear/dropbear_rsa_host_key)
#DROPBEAR_RSAKEY="/etc/dropbear/dropbear_rsa_host_key"

# DSS hostkey file (default: /etc/dropbear/dropbear_dss_host_key)
#DROPBEAR_DSSKEY="/etc/dropbear/dropbear_dss_host_key"

# ECDSA hostkey file (default: /etc/dropbear/dropbear_ecdsa_host_key)
#DROPBEAR_ECDSAKEY="/etc/dropbear/dropbear_ecdsa_host_key"

# Receive window size - this is a tradeoff between memory and
# network performance
DROPBEAR_RECEIVE_WINDOW=65536
EOF
    
    echo -e "${GREEN}‚úÖ Configuraci√≥n de Dropbear limpiada${NC}"
}

# üìä Funci√≥n para mostrar puertos (versi√≥n inline)
show_ports_inline() {
    if [ ! -f /etc/default/dropbear ]; then
        echo -e "${RED}‚ùå Archivo de configuraci√≥n no encontrado${NC}"
        return
    fi
    
    main_port=$(awk -F= '/^DROPBEAR_PORT=/ {print $2}' /etc/default/dropbear)
    extra_ports=$(awk -F'-p ' '/DROPBEAR_EXTRA_ARGS=/ {
        for (i=2; i<=NF; i++) {
            print $i
        }
    }' /etc/default/dropbear | cut -d' ' -f1 | tr -d '"' | sort -n | uniq)
    
    local ports_list=""
    
    if [ -n "$main_port" ]; then
        ports_list="$main_port (principal)"
    fi
    
    if [ -n "$extra_ports" ]; then
        while read -r port; do
            if [ -n "$port" ]; then
                if [ -n "$ports_list" ]; then
                    ports_list="$ports_list, $port"
                else
                    ports_list="$port"
                fi
            fi
        done <<< "$extra_ports"
    fi
    
    if [ -n "$ports_list" ]; then
        echo -e "${WHITE}   üîå $ports_list${NC}"
    else
        echo -e "${YELLOW}   ‚ö†Ô∏è  No hay puertos configurados${NC}"
    fi
}

# üìä Mostrar puertos en uso seg√∫n la configuraci√≥n de Dropbear
show_ports() {
    show_banner
    echo -e "${BOLD}${BLUE}üìä PUERTOS CONFIGURADOS${NC}"
    echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""
    
    if ! command -v dropbear &> /dev/null; then
        echo -e "${YELLOW}‚ö†Ô∏è  Dropbear no est√° instalado${NC}"
        read -p "Presiona Enter para continuar..."
        return
    fi
    
    if [ ! -f /etc/default/dropbear ]; then
        echo -e "${RED}‚ùå El archivo de configuraci√≥n de Dropbear no se encontr√≥${NC}"
        read -p "Presiona Enter para continuar..."
        return
    fi
    
    echo -e "${WHITE}üìã Estado de puertos Dropbear:${NC}"
    echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    printf "%-10s %-15s %-10s\n" "PUERTO" "TIPO" "ESTADO"
    echo -e "${CYAN}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}"
    
    main_port=$(awk -F= '/^DROPBEAR_PORT=/ {print $2}' /etc/default/dropbear)
    extra_ports=$(awk -F'-p ' '/DROPBEAR_EXTRA_ARGS=/ {
        for (i=2; i<=NF; i++) {
            print $i
        }
    }' /etc/default/dropbear | cut -d' ' -f1 | tr -d '"' | sort -n | uniq)
    
    local found_ports=false
    
    if [ -n "$main_port" ]; then
        if netstat -tuln | grep ":$main_port " > /dev/null; then
            status="${GREEN}‚úÖ ACTIVO${NC}"
        else
            status="${RED}‚ùå INACTIVO${NC}"
        fi
        printf "%-10s %-15s %-20s\n" "$main_port" "Principal" "$status"
        found_ports=true
    fi
    
    if [ -n "$extra_ports" ]; then
        while read -r port; do
            if [ -n "$port" ]; then
                if netstat -tuln | grep ":$port " > /dev/null; then
                    status="${GREEN}‚úÖ ACTIVO${NC}"
                else
                    status="${RED}‚ùå INACTIVO${NC}"
                fi
                printf "%-10s %-15s %-20s\n" "$port" "Adicional" "$status"
                found_ports=true
            fi
        done <<< "$extra_ports"
    fi
    
    if [ "$found_ports" = false ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  No se encontraron puertos configurados para Dropbear${NC}"
    fi
    
    echo ""
    # Mostrar estado del servicio
    if pgrep -x "dropbear" > /dev/null; then
        echo -e "${WHITE}üîß Estado del servicio: ${GREEN}‚úÖ EJECUT√ÅNDOSE${NC}"
    else
        echo -e "${WHITE}üîß Estado del servicio: ${RED}‚ùå DETENIDO${NC}"
    fi
    
    read -p "Presiona Enter para continuar..."
}

# üë§ Crear usuarios temporales
create_user() {
    show_banner
    echo -e "${BOLD}${BLUE}üë§ CREAR USUARIO TEMPORAL${NC}"
    echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""
    
    read -p "üë§ Ingrese el nombre de usuario: " username
    
    # Validar nombre de usuario
    if [[ ! "$username" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        echo -e "${RED}‚ùå Nombre de usuario inv√°lido. Use solo letras, n√∫meros, guiones y guiones bajos.${NC}"
        read -p "Presiona Enter para continuar..."
        return
    fi
    
    if id "$username" &>/dev/null; then
        echo -e "${RED}‚ùå El usuario '$username' ya existe${NC}"
        read -p "Presiona Enter para continuar..."
        return
    fi
    
    read -p "üìÖ Ingrese el n√∫mero de d√≠as de validez: " days
    
    if ! [[ "$days" =~ ^[0-9]+$ ]] || [ "$days" -lt 1 ]; then
        echo -e "${RED}‚ùå N√∫mero de d√≠as inv√°lido${NC}"
        read -p "Presiona Enter para continuar..."
        return
    fi
    
    echo -e "${YELLOW}üîß Creando usuario...${NC}"
    
    if useradd -m -s /bin/false -e $(date -d "+$days days" +%Y-%m-%d) "$username"; then
        echo -e "${YELLOW}üîí Configure la contrase√±a para $username:${NC}"
        if passwd "$username"; then
            echo -e "${GREEN}‚úÖ Usuario $username creado exitosamente${NC}"
            echo -e "${WHITE}üìÖ Expira en: ${YELLOW}$(date -d "+$days days" +%Y-%m-%d)${NC}"
        else
            echo -e "${RED}‚ùå Error al configurar la contrase√±a${NC}"
            userdel -r "$username" 2>/dev/null
        fi
    else
        echo -e "${RED}‚ùå Error al crear el usuario${NC}"
    fi
    
    read -p "Presiona Enter para continuar..."
}

# üìã Listar usuarios
list_users() {
    show_banner
    echo -e "${BOLD}${BLUE}üìã LISTA DE USUARIOS${NC}"
    echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""
    
    echo -e "${WHITE}üë• Usuarios del sistema (UID >= 1000):${NC}"
    echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    printf "%-15s %-15s %-20s %-10s\n" "USUARIO" "UID" "EXPIRACI√ìN" "ESTADO"
    echo -e "${CYAN}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}"
    
    local found_users=false
    
    while IFS=: read -r username x uid gid gecos home shell; do
        if [ "$uid" -ge 1000 ] && [ "$username" != "nobody" ]; then
            found_users=true
            
            # Obtener fecha de expiraci√≥n
            expiry=$(chage -l "$username" 2>/dev/null | grep "Account expires" | cut -d: -f2 | xargs)
            
            if [ "$expiry" = "never" ]; then
                expiry_display="${GREEN}Never${NC}"
                status="${GREEN}‚úÖ ACTIVO${NC}"
            else
                expiry_date=$(date -d "$expiry" +%Y-%m-%d 2>/dev/null || echo "N/A")
                if [ "$expiry_date" != "N/A" ] && [ $(date -d "$expiry_date" +%s) -lt $(date +%s) ]; then
                    expiry_display="${RED}$expiry_date${NC}"
                    status="${RED}‚ùå EXPIRADO${NC}"
                else
                    expiry_display="${YELLOW}$expiry_date${NC}"
                    status="${GREEN}‚úÖ ACTIVO${NC}"
                fi
            fi
            
            printf "%-15s %-15s %-30s %-20s\n" "$username" "$uid" "$expiry_display" "$status"
        fi
    done < /etc/passwd
    
    if [ "$found_users" = false ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  No se encontraron usuarios regulares${NC}"
    fi
    
    read -p "Presiona Enter para continuar..."
}

# üìÖ Extender d√≠as de usuario
extend_user_days() {
    show_banner
    echo -e "${BOLD}${BLUE}üìÖ EXTENDER D√çAS DE USUARIO${NC}"
    echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""
    read -p "üë§ Ingrese el nombre de usuario: " username
   
   if ! id "$username" >/dev/null 2>&1; then
       echo -e "${RED}‚ùå El usuario $username no existe${NC}"
       read -p "Presiona Enter para continuar..."
       return
   fi
   
   read -p "üìÖ Ingrese el n√∫mero de d√≠as a a√±adir: " days
   
   if ! [[ "$days" =~ ^[0-9]+$ ]] || [ "$days" -lt 1 ]; then
       echo -e "${RED}‚ùå N√∫mero de d√≠as inv√°lido${NC}"
       read -p "Presiona Enter para continuar..."
       return
   fi
   
   current_expiry=$(chage -l "$username" 2>/dev/null | grep "Account expires" | cut -d: -f2 | xargs)
   
   if [ "$current_expiry" = "never" ]; then
       new_expiry=$(date -d "+$days days" +%Y-%m-%d)
   else
       new_expiry=$(date -d "$current_expiry +$days days" +%Y-%m-%d 2>/dev/null)
       if [ $? -ne 0 ]; then
           echo -e "${RED}‚ùå Error al calcular la nueva fecha de expiraci√≥n${NC}"
           read -p "Presiona Enter para continuar..."
           return
       fi
   fi
   
   if chage -E "$new_expiry" "$username"; then
       echo -e "${GREEN}‚úÖ Se han a√±adido $days d√≠as a la cuenta de $username${NC}"
       echo -e "${WHITE}üìÖ Nueva fecha de expiraci√≥n: ${YELLOW}$new_expiry${NC}"
   else
       echo -e "${RED}‚ùå Error al actualizar la fecha de expiraci√≥n${NC}"
   fi
   
   read -p "Presiona Enter para continuar..."
}

# üìâ Reducir d√≠as de usuario
reduce_user_days() {
   show_banner
   echo -e "${BOLD}${BLUE}üìâ REDUCIR D√çAS DE USUARIO${NC}"
   echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
   echo ""
   
   read -p "üë§ Ingrese el nombre de usuario: " username
   
   if ! id "$username" >/dev/null 2>&1; then
       echo -e "${RED}‚ùå El usuario $username no existe${NC}"
       read -p "Presiona Enter para continuar..."
       return
   fi
   
   read -p "üìÖ Ingrese el n√∫mero de d√≠as a reducir: " days
   
   if ! [[ "$days" =~ ^[0-9]+$ ]] || [ "$days" -lt 1 ]; then
       echo -e "${RED}‚ùå N√∫mero de d√≠as inv√°lido${NC}"
       read -p "Presiona Enter para continuar..."
       return
   fi
   
   current_expiry=$(chage -l "$username" 2>/dev/null | grep "Account expires" | cut -d: -f2 | xargs)
   
   if [ "$current_expiry" = "never" ]; then
       echo -e "${YELLOW}‚ö†Ô∏è  El usuario no tiene fecha de expiraci√≥n establecida${NC}"
       read -p "Presiona Enter para continuar..."
       return
   fi
   
   new_expiry=$(date -d "$current_expiry -$days days" +%Y-%m-%d 2>/dev/null)
   if [ $? -ne 0 ]; then
       echo -e "${RED}‚ùå Error al calcular la nueva fecha de expiraci√≥n${NC}"
       read -p "Presiona Enter para continuar..."
       return
   fi
   
   if chage -E "$new_expiry" "$username"; then
       echo -e "${GREEN}‚úÖ Se han reducido $days d√≠as de la cuenta de $username${NC}"
       echo -e "${WHITE}üìÖ Nueva fecha de expiraci√≥n: ${YELLOW}$new_expiry${NC}"
   else
       echo -e "${RED}‚ùå Error al actualizar la fecha de expiraci√≥n${NC}"
   fi
   
   read -p "Presiona Enter para continuar..."
}

# üîê Actualizar contrase√±a de usuario
update_user_password() {
   show_banner
   echo -e "${BOLD}${BLUE}üîê ACTUALIZAR CONTRASE√ëA${NC}"
   echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
   echo ""
   
   read -p "üë§ Ingrese el nombre de usuario: " username
   
   if ! id "$username" >/dev/null 2>&1; then
       echo -e "${RED}‚ùå El usuario $username no existe${NC}"
       read -p "Presiona Enter para continuar..."
       return
   fi
   
   echo -e "${YELLOW}üîí Configure la nueva contrase√±a para $username:${NC}"
   if passwd "$username"; then
       echo -e "${GREEN}‚úÖ Contrase√±a actualizada exitosamente${NC}"
   else
       echo -e "${RED}‚ùå Error al actualizar la contrase√±a${NC}"
   fi
   
   read -p "Presiona Enter para continuar..."
}

# üóëÔ∏è Eliminar usuario
delete_user() {
   show_banner
   echo -e "${BOLD}${BLUE}üóëÔ∏è  ELIMINAR USUARIO${NC}"
   echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
   echo ""
   
   read -p "üë§ Ingrese el nombre de usuario a eliminar: " username
   
   if ! id "$username" >/dev/null 2>&1; then
       echo -e "${RED}‚ùå El usuario $username no existe${NC}"
       read -p "Presiona Enter para continuar..."
       return
   fi
   
   echo -e "${YELLOW}‚ö†Ô∏è  ADVERTENCIA: Esta acci√≥n eliminar√° completamente al usuario y su directorio home${NC}"
   read -p "üóëÔ∏è  ¬øEst√° seguro que desea eliminar el usuario '$username'? (s/N): " confirm
   
   if [[ "$confirm" =~ ^[Ss]$ ]]; then
       if userdel -r "$username" 2>/dev/null; then
           echo -e "${GREEN}‚úÖ Usuario $username eliminado exitosamente${NC}"
       else
           echo -e "${RED}‚ùå Error al eliminar el usuario${NC}"
       fi
   else
       echo -e "${YELLOW}‚ùå Operaci√≥n cancelada${NC}"
   fi
   
   read -p "Presiona Enter para continuar..."
}

# üë• Menu de gesti√≥n de usuarios
manage_users_menu() {
   while true; do
       show_banner
       echo -e "${BOLD}${BLUE}üë• GESTI√ìN DE USUARIOS${NC}"
       echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
       echo ""
       echo -e "${WHITE}üìã Seleccione una opci√≥n:${NC}"
       echo ""
       echo -e "  ${YELLOW}1.${NC} üë§ Crear usuario temporal"
       echo -e "  ${YELLOW}2.${NC} üìã Listar usuarios"
       echo -e "  ${YELLOW}3.${NC} üìÖ Extender d√≠as de existencia"
       echo -e "  ${YELLOW}4.${NC} üìâ Reducir d√≠as de existencia"
       echo -e "  ${YELLOW}5.${NC} üîê Actualizar contrase√±a"
       echo -e "  ${YELLOW}6.${NC} üóëÔ∏è  Eliminar usuario"
       echo -e "  ${YELLOW}7.${NC} üîô Volver al men√∫ principal"
       echo ""
       echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
       read -p "üî¢ Seleccione una opci√≥n [1-7]: " option

       case $option in
           1) create_user ;;
           2) list_users ;;
           3) extend_user_days ;;
           4) reduce_user_days ;;
           5) update_user_password ;;
           6) delete_user ;;
           7) break ;;
           *) 
               echo -e "${RED}‚ùå Opci√≥n no v√°lida${NC}"
               sleep 1
           ;;
       esac
   done
}

# üîÑ Funci√≥n para actualizar el script
update_script() {
   show_banner
   echo -e "${BOLD}${BLUE}üîÑ ACTUALIZAR SCRIPT${NC}"
   echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
   echo ""
   
   SCRIPT_URL="https://raw.githubusercontent.com/Pedro-111/dropbear_manager/master/dropbear_manager.sh"
   CURRENT_SCRIPT="$0"
   
   echo -e "${YELLOW}üåê Verificando actualizaciones...${NC}"
   
   # Descargar el nuevo script con indicador de progreso
   if curl -s --connect-timeout 10 "$SCRIPT_URL" -o "${CURRENT_SCRIPT}.tmp"; then
       if [ -s "${CURRENT_SCRIPT}.tmp" ]; then
           # Verificar si el archivo descargado es v√°lido
           if head -1 "${CURRENT_SCRIPT}.tmp" | grep -q "^#!/bin/bash"; then
               chmod +x "${CURRENT_SCRIPT}.tmp"
               mv "${CURRENT_SCRIPT}.tmp" "$CURRENT_SCRIPT"
               
               echo -e "${GREEN}‚úÖ Script actualizado exitosamente${NC}"
               echo -e "${YELLOW}üîÑ Por favor, reinicie el script para usar la nueva versi√≥n${NC}"
               
               read -p "üîÑ ¬øDesea reiniciar el script ahora? (s/n): " restart_choice
               if [[ "$restart_choice" =~ ^[Ss]$ ]]; then
                   echo -e "${BLUE}üöÄ Reiniciando script...${NC}"
                   exec "$CURRENT_SCRIPT"
               fi
           else
               echo -e "${RED}‚ùå El archivo descargado no es v√°lido${NC}"
               rm -f "${CURRENT_SCRIPT}.tmp"
           fi
       else
           echo -e "${RED}‚ùå El archivo descargado est√° vac√≠o${NC}"
           rm -f "${CURRENT_SCRIPT}.tmp"
       fi
   else
       echo -e "${RED}‚ùå Error al conectar con el servidor${NC}"
       echo -e "${YELLOW}üí° Verifique su conexi√≥n a internet${NC}"
   fi
   
   read -p "Presiona Enter para continuar..."
}

# üóëÔ∏è Funci√≥n para desinstalar
uninstall() {
   show_banner
   echo -e "${BOLD}${RED}üóëÔ∏è  DESINSTALACI√ìN${NC}"
   echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
   echo ""
   
   echo -e "${YELLOW}‚ö†Ô∏è  ADVERTENCIA: Esta acci√≥n eliminar√° componentes del sistema${NC}"
   echo ""
   
   # Opci√≥n para desinstalar el script
   echo -e "${WHITE}üîß Componentes a desinstalar:${NC}"
   echo ""
   read -p "üóëÔ∏è  ¬øDesea desinstalar el script Dropbear Manager? (s/n): " uninstall_script
   read -p "üóëÔ∏è  ¬øDesea desinstalar Dropbear completamente? (s/n): " uninstall_dropbear
   echo ""
   
   if [[ "$uninstall_script" =~ ^[Ss]$ ]]; then
       echo -e "${RED}üóëÔ∏è  Desinstalando script...${NC}"
       
       # Eliminar el script
       if [ -f "/usr/local/bin/dropbear_manager.sh" ]; then
           rm -f "/usr/local/bin/dropbear_manager.sh"
           echo -e "${GREEN}‚úÖ Script principal eliminado${NC}"
       fi
       
       # Eliminar enlace simb√≥lico
       if [ -L "/usr/local/bin/dropbear-manager" ]; then
           rm -f "/usr/local/bin/dropbear-manager"
           echo -e "${GREEN}‚úÖ Comando global eliminado${NC}"
       fi
   fi
   
   if [[ "$uninstall_dropbear" =~ ^[Ss]$ ]]; then
       echo -e "${RED}üóëÔ∏è  Desinstalando Dropbear...${NC}"
       
       # Detener el servicio
       service dropbear stop > /dev/null 2>&1
       
       # Remover paquete
       apt-get remove --purge -y dropbear > /dev/null 2>&1
       apt-get autoremove -y > /dev/null 2>&1
       
       # Eliminar configuraciones
       rm -rf /etc/dropbear /etc/default/dropbear
       
       echo -e "${GREEN}‚úÖ Dropbear desinstalado completamente${NC}"
   fi
   
   echo ""
   if [[ "$uninstall_script" =~ ^[Ss]$ ]] || [[ "$uninstall_dropbear" =~ ^[Ss]$ ]]; then
       echo -e "${GREEN}üéâ Desinstalaci√≥n completada${NC}"
       
       if [[ "$uninstall_script" =~ ^[Ss]$ ]]; then
           echo -e "${YELLOW}üëã ¬°Gracias por usar Dropbear Manager!${NC}"
           exit 0
       fi
   else
       echo -e "${YELLOW}‚ùå Operaci√≥n cancelada${NC}"
   fi
   
   read -p "Presiona Enter para continuar..."
}

# üêõ Funci√≥n para habilitar la depuraci√≥n en Dropbear
enable_debugging() {
   show_banner
   echo -e "${BOLD}${BLUE}üêõ DEPURACI√ìN DE DROPBEAR${NC}"
   echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
   echo ""
   
   if ! command -v dropbear &> /dev/null; then
       echo -e "${RED}‚ùå Dropbear no est√° instalado${NC}"
       read -p "Presiona Enter para continuar..."
       return
   fi
   
   current_args=$(grep "^DROPBEAR_EXTRA_ARGS=" /etc/default/dropbear | cut -d'"' -f2)
   
   if echo "$current_args" | grep -q "\-v"; then
       echo -e "${YELLOW}‚ö†Ô∏è  La depuraci√≥n ya est√° habilitada${NC}"
       read -p "üîÑ ¬øDesea deshabilitarla? (s/n): " disable_debug
       if [[ "$disable_debug" =~ ^[Ss]$ ]]; then
           new_args=$(echo "$current_args" | sed 's/-v//g' | sed 's/  */ /g' | sed 's/^ *//' | sed 's/ *$//')
           sed -i "s/^DROPBEAR_EXTRA_ARGS=.*/DROPBEAR_EXTRA_ARGS=\"$new_args\"/" /etc/default/dropbear
           restart_dropbear
           echo -e "${GREEN}‚úÖ Depuraci√≥n deshabilitada${NC}"
       fi
   else
       echo -e "${YELLOW}üêõ Habilitando depuraci√≥n verbosa...${NC}"
       new_args="$current_args -v"
       sed -i "s/^DROPBEAR_EXTRA_ARGS=.*/DROPBEAR_EXTRA_ARGS=\"$new_args\"/" /etc/default/dropbear
       restart_dropbear
       echo -e "${GREEN}‚úÖ Depuraci√≥n habilitada${NC}"
       echo -e "${WHITE}üìã Use 'journalctl -f -u dropbear' para ver los logs en tiempo real${NC}"
   fi
   
   read -p "Presiona Enter para continuar..."
}

# üîë Funci√≥n para verificar y convertir claves
verify_and_convert_keys() {
   show_banner
   echo -e "${BOLD}${BLUE}üîë VERIFICAR CLAVES SSH${NC}"
   echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
   echo ""
   
   if ! command -v dropbear &> /dev/null; then
       echo -e "${RED}‚ùå Dropbear no est√° instalado${NC}"
       read -p "Presiona Enter para continuar..."
       return
   fi
   
   echo -e "${YELLOW}üîç Verificando claves existentes...${NC}"
   
   local keys_checked=0
   local keys_ok=0
   
   # Verificar clave RSA
   if [ -f "/etc/dropbear/dropbear_rsa_host_key" ]; then
       keys_checked=$((keys_checked + 1))
       if [ -f "/etc/dropbear/dropbear_rsa_host_key.pub" ]; then
           echo -e "${GREEN}‚úÖ Clave RSA encontrada${NC}"
           keys_ok=$((keys_ok + 1))
       else
           echo -e "${YELLOW}‚ö†Ô∏è  Clave p√∫blica RSA faltante${NC}"
       fi
   fi
   
   # Verificar clave DSS
   if [ -f "/etc/dropbear/dropbear_dss_host_key" ]; then
       keys_checked=$((keys_checked + 1))
       if [ -f "/etc/dropbear/dropbear_dss_host_key.pub" ]; then
           echo -e "${GREEN}‚úÖ Clave DSS encontrada${NC}"
           keys_ok=$((keys_ok + 1))
       else
           echo -e "${YELLOW}‚ö†Ô∏è  Clave p√∫blica DSS faltante${NC}"
       fi
   fi
   
   # Verificar clave ECDSA
   if [ -f "/etc/dropbear/dropbear_ecdsa_host_key" ]; then
       keys_checked=$((keys_checked + 1))
       if [ -f "/etc/dropbear/dropbear_ecdsa_host_key.pub" ]; then
           echo -e "${GREEN}‚úÖ Clave ECDSA encontrada${NC}"
           keys_ok=$((keys_ok + 1))
       else
           echo -e "${YELLOW}‚ö†Ô∏è  Clave p√∫blica ECDSA faltante${NC}"
       fi
   fi
   
   if [ $keys_checked -eq 0 ]; then
       echo -e "${RED}‚ùå No se encontraron claves. Generando nuevas...${NC}"
       generate_keys
   elif [ $keys_ok -eq $keys_checked ]; then
       echo -e "${GREEN}‚úÖ Todas las claves est√°n correctas${NC}"
   else
       echo -e "${YELLOW}‚ö†Ô∏è  Algunas claves necesitan reparaci√≥n${NC}"
       read -p "üîß ¬øDesea regenerar las claves? (s/n): " regen_keys
       if [[ "$regen_keys" =~ ^[Ss]$ ]]; then
           generate_keys
       fi
   fi
   
   read -p "Presiona Enter para continuar..."
}

# üîê Funci√≥n para generar claves si no existen
generate_keys() {
   echo -e "${YELLOW}üîê Generando claves para Dropbear...${NC}"
   
   # Crear directorio si no existe
   mkdir -p /etc/dropbear
   
   # Generar clave RSA
   echo -e "${YELLOW}üîë Generando clave RSA...${NC}"
   if dropbearkey -t rsa -f /etc/dropbear/dropbear_rsa_host_key > /dev/null 2>&1; then
       echo -e "${GREEN}‚úÖ Clave RSA generada${NC}"
   else
       echo -e "${RED}‚ùå Error generando clave RSA${NC}"
   fi
   
   # Generar clave DSS
   echo -e "${YELLOW}üîë Generando clave DSS...${NC}"
   if dropbearkey -t dss -f /etc/dropbear/dropbear_dss_host_key > /dev/null 2>&1; then
       echo -e "${GREEN}‚úÖ Clave DSS generada${NC}"
   else
       echo -e "${RED}‚ùå Error generando clave DSS${NC}"
   fi
   
   # Generar clave ECDSA
   echo -e "${YELLOW}üîë Generando clave ECDSA...${NC}"
   if dropbearkey -t ecdsa -f /etc/dropbear/dropbear_ecdsa_host_key > /dev/null 2>&1; then
       echo -e "${GREEN}‚úÖ Clave ECDSA generada${NC}"
   else
       echo -e "${RED}‚ùå Error generando clave ECDSA${NC}"
   fi
   
   # Establecer permisos correctos
   chmod 600 /etc/dropbear/dropbear_*_host_key
   chmod 644 /etc/dropbear/dropbear_*_host_key.pub 2>/dev/null || true
   
   echo -e "${GREEN}‚úÖ Generaci√≥n de claves completada${NC}"
}

# üìä Funci√≥n para mostrar informaci√≥n del sistema
show_system_info() {
   show_banner
   echo -e "${BOLD}${BLUE}üìä INFORMACI√ìN DEL SISTEMA${NC}"
   echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
   echo ""
   
   # Informaci√≥n del servidor
   echo -e "${WHITE}üñ•Ô∏è  Informaci√≥n del Servidor:${NC}"
   echo -e "${CYAN}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}"
   echo -e "${WHITE}   üè∑Ô∏è  Hostname: ${YELLOW}$(hostname)${NC}"
   echo -e "${WHITE}   üêß OS: ${YELLOW}$(lsb_release -d 2>/dev/null | cut -f2 || echo "$(cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)")${NC}"
   echo -e "${WHITE}   ‚ö° Kernel: ${YELLOW}$(uname -r)${NC}"
   echo -e "${WHITE}   üèõÔ∏è  Arquitectura: ${YELLOW}$(uname -m)${NC}"
   echo -e "${WHITE}   ‚è∞ Uptime: ${YELLOW}$(uptime -p)${NC}"
   
   echo ""
   
   # Estado de Dropbear
   echo -e "${WHITE}üîê Estado de Dropbear:${NC}"
   echo -e "${CYAN}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}"
   if command -v dropbear &> /dev/null; then
       echo -e "${WHITE}   üì¶ Instalado: ${GREEN}‚úÖ S√ç${NC}"
       
       if pgrep -x "dropbear" > /dev/null; then
           echo -e "${WHITE}   üîß Estado: ${GREEN}‚úÖ EJECUT√ÅNDOSE${NC}"
           echo -e "${WHITE}   üë§ Procesos: ${YELLOW}$(pgrep -x "dropbear" | wc -l)${NC}"
       else
           echo -e "${WHITE}   üîß Estado: ${RED}‚ùå DETENIDO${NC}"
       fi
       
       # Mostrar puertos configurados
       echo -e "${WHITE}   üîå Puertos configurados:${NC}"
       show_ports_inline
   else
       echo -e "${WHITE}   üì¶ Instalado: ${RED}‚ùå NO${NC}"
   fi
   
   echo ""
   
   # Recursos del sistema
   echo -e "${WHITE}üíª Recursos del Sistema:${NC}"
   echo -e "${CYAN}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}"
   
   # CPU
   local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//')
   echo -e "${WHITE}   üî• CPU: ${YELLOW}${cpu_usage}% usado${NC}"
   
   # Memoria
   local mem_info=$(free -h | grep "Mem:")
   local mem_used=$(echo $mem_info | awk '{print $3}')
   local mem_total=$(echo $mem_info | awk '{print $2}')
   echo -e "${WHITE}   üß† RAM: ${YELLOW}${mem_used}/${mem_total} usado${NC}"
   
   # Espacio en disco
   local disk_info=$(df -h / | tail -1)
   local disk_used=$(echo $disk_info | awk '{print $3}')
   local disk_total=$(echo $disk_info | awk '{print $2}')
   local disk_percent=$(echo $disk_info | awk '{print $5}')
   echo -e "${WHITE}   üíæ Disco: ${YELLOW}${disk_used}/${disk_total} (${disk_percent}) usado${NC}"
   
   echo ""
   
   # Conexiones activas
   echo -e "${WHITE}üåê Conexiones SSH Activas:${NC}"
   echo -e "${CYAN}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}"
   local ssh_connections=$(netstat -tn 2>/dev/null | grep ":22\|:$(grep DROPBEAR_PORT /etc/default/dropbear 2>/dev/null | cut -d'=' -f2)" | grep ESTABLISHED | wc -l)
   echo -e "${WHITE}   üìä Conexiones activas: ${YELLOW}${ssh_connections}${NC}"
   
   read -p "Presiona Enter para continuar..."
}

# üìã Funci√≥n principal del men√∫
main_menu() {
   # Verificar root al inicio
   check_root
   
   # Verificar dependencias
   check_dependencies
   
   while true; do
       show_banner
       echo -e "${WHITE}üöÄ Bienvenido a Dropbear Manager v2.0${NC}"
       echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
       echo ""
       echo -e "${WHITE}üìã Seleccione una opci√≥n:${NC}"
       echo ""
       echo -e "  ${YELLOW} 1.${NC} üì• Instalar Dropbear"
       echo -e "  ${YELLOW} 2.${NC} üîì Abrir puertos adicionales"
       echo -e "  ${YELLOW} 3.${NC} üîí Cerrar puertos"
       echo -e "  ${YELLOW} 4.${NC} üìä Mostrar puertos configurados"
       echo -e "  ${YELLOW} 5.${NC} üë• Gestionar usuarios"
       echo -e "  ${YELLOW} 6.${NC} üîÑ Actualizar script"
       echo -e "  ${YELLOW} 7.${NC} üßπ Limpiar configuraci√≥n"
       echo -e "  ${YELLOW} 8.${NC} üìä Informaci√≥n del sistema"
       echo -e "  ${YELLOW} 9.${NC} üêõ Habilitar/Deshabilitar depuraci√≥n"
       echo -e "  ${YELLOW}10.${NC} üîë Verificar y generar claves"
       echo -e "  ${YELLOW}11.${NC} üóëÔ∏è  Desinstalar"
       echo -e "  ${YELLOW}12.${NC} üö™ Salir"
       echo ""
       echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
       read -p "üî¢ Seleccione una opci√≥n [1-12]: " choice

       case $choice in
           1) install_dropbear ;;
           2) open_ports ;;
           3) close_port ;;
           4) show_ports ;;
           5) manage_users_menu ;;
           6) update_script ;;
           7) 
               clean_dropbear_config
               echo -e "${GREEN}‚úÖ Configuraci√≥n limpiada exitosamente${NC}"
               read -p "Presiona Enter para continuar..."
           ;;
           8) show_system_info ;;
           9) enable_debugging ;;
           10) 
               verify_and_convert_keys
               generate_keys
           ;;
           11) uninstall ;;
           12) 
               echo -e "${GREEN}üëã ¬°Gracias por usar Dropbear Manager!${NC}"
               exit 0 
           ;;
           *) 
               echo -e "${RED}‚ùå Opci√≥n no v√°lida. Por favor seleccione un n√∫mero del 1 al 12.${NC}"
               sleep 2
           ;;
       esac
   done
}

# üöÄ Ejecutar el programa principal
main_menu
